<!DOCTYPE html>
<html>
<head>
    <title>Orders</title>
    <link rel="stylesheet" type="text/css" href="/css/orders.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let currentPage = 1;

        function connect() {
            const socket = new SockJS('http://localhost:888/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/orders', function (order) {
                    console.log('Received order update:', order);
                    try {
                        const parsedOrder = JSON.parse(order.body);
                        console.log('Parsed order:', parsedOrder);
                        showOrder(parsedOrder);
                    } catch (e) {
                        console.error('Error parsing order:', e);
                    }
                });
            }, function (error) {
                console.error('WebSocket connection error:', error);
            });
        }

        function showOrder(order) {
            console.log('Updating DOM with new order:', order);
            const orderList = document.getElementById("orderList");
            const orderElement = document.createElement("li");
            orderElement.innerHTML = `
                <div class="order">
                    <div><strong>Order ID:</strong> ${order.id}</div>
                    <div><strong>Created Time:</strong> ${order.createdTime}</div>
                    <div><strong>User:</strong> ${order.userFullName} (${order.phone})</div>
                    <div><strong>Address:</strong> <a href="${order.addressLocationLink}" target="_blank">${order.address}</a></div>
                    <div><strong>Distance:</strong> ${order.distance} km</div>
                    <div><strong>Sum for Delivery:</strong> $${parseFloat(order.sumForDelivery).toFixed(2)}</div>
                    <div><strong>Total Sum:</strong> $${parseFloat(order.totalSum).toFixed(2)}</div>
                    <div><strong>Comments:</strong> ${order.comments}</div>
                    <div><strong>Delivery:</strong> ${order.isDelivery ? 'Yes' : 'No'}</div>
                    <div><strong>Delivered:</strong> ${order.isDelivered ? 'Yes' : 'No'}</div>
                    <div><strong>Scheduled Delivery Time:</strong> ${order.scheduledDeliveryTime}</div>
                    <div><strong>Branch:</strong> ${order.branchName}</div>
                    <div class="items">
                        <h4>Items:</h4>
                        <ul>
                            ${order.itemsList.map(item => `
                                <li>
                                    <div><strong>Item Name:</strong> ${item.nameEng}</div>
                                    <div><strong>Quantity:</strong> ${item.quantity}</div>
                                    <div><strong>Total Price:</strong> $${parseFloat(item.totalPrice).toFixed(2)}</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
            orderList.appendChild(orderElement);
        }

        function fetchOrders(page) {
            fetch('http://localhost:888/api/v1/orders/all?page=' + page, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer eyJhbGciOiJIUzUxMiJ9.eyJpZCI6MSwicm9sZSI6IkFETUlOIiwiZXhwIjoxNzIzNDQyOTcyfQ.AUh9x8n2Pp9CSKAPSdvNAixg0T80gNr9KCCBTJatPLX1iRz3qwYp4CxXqD9BdIWMR2UtNvi1J_3imdFlBmqf1A'
                }
            })
                .then(response => response.json())
                .then(data => {
                    const orderList = document.getElementById("orderList");
                    orderList.innerHTML = '';
                    data.content.forEach(order => {
                        showOrder(order);
                    });
                    updatePagination(data.page);
                });
        }

        function updatePagination(page) {
            document.getElementById("pagination").innerHTML = `
                <button onclick="fetchOrders(${page.number})" ${page.number === 0 ? 'disabled' : ''}>Previous</button>
                <span>Page ${page.number + 1} of ${page.totalPages}</span>
                <button onclick="fetchOrders(${page.number + 2})" ${page.number + 1 === page.totalPages ? 'disabled' : ''}>Next</button>
            `;
        }

        document.addEventListener("DOMContentLoaded", function () {
            connect();
            fetchOrders(currentPage);
        });
    </script>
</head>
<body>
<h1>Orders</h1>
<ul id="orderList">
    <!-- Existing orders will be listed here -->
</ul>
<div id="pagination"></div>
</body>
</html>
